
# Resumen: Autenticaci√≥n con JWT en Node.js y Express

## üîê Autenticaci√≥n vs Autorizaci√≥n

- **Autenticaci√≥n**: Verifica qui√©n eres. Se hace con usuario/contrase√±a.
- **Autorizaci√≥n**: Verifica qu√© puedes hacer una vez identificado.

---

## ü™ô ¬øQu√© es JWT?

JWT (JSON Web Token) permite transmitir informaci√≥n segura entre cliente y servidor. Se compone de:

1. **Header** ‚Äì Algoritmo y tipo:
   ```json
   { "alg": "HS256", "typ": "JWT" }
   ```

2. **Payload** ‚Äì Datos del usuario:
   ```json
   { "id": "1", "name": "Ana" }
   ```

3. **Signature** ‚Äì Validaci√≥n con clave secreta.

El token final tiene el formato:
```
xxxxx.yyyyy.zzzzz
```

---

## ‚öôÔ∏è Instalaci√≥n y configuraci√≥n

```bash
npm install jsonwebtoken bcrypt
```

```js
const jwt = require('jsonwebtoken');
const bcrypt = require('bcrypt');
```

---

## üß™ Registro de usuario (Signup)

```js
app.post("/api/signup", async (req, res) => {
  const { username, email, password } = req.body;
  const passwordHash = await bcrypt.hash(password, 10);
  const sql = "INSERT INTO users (username, email, hashed_password) VALUES (?, ?, ?)";

  jwt.sign(password, "secret_key", async (err, token) => {
    if (err) return res.status(400).send({ msg: "Error" });

    const connection = await getConnection();
    const [results] = await connection.query(sql, [username, email, passwordHash]);
    connection.end();

    res.json({ msg: "success", token, id: results.insertId });
  });
});
```

---

## üîë Inicio de sesi√≥n (Login)

```js
app.post("/api/login", async (req, res) => {
  const { username, password } = req.body;
  const sql = "SELECT * FROM users WHERE username = ?";
  const connection = await getConnection();
  const [users] = await connection.query(sql, [username]);
  connection.end();

  const user = users[0];
  const passwordCorrect = user && await bcrypt.compare(password, user.hashed_password);

  if (!passwordCorrect) return res.status(401).json({ error: "Credenciales inv√°lidas" });

  const userForToken = { username: user.username, id: user.id };
  const token = generateToken(userForToken);

  res.status(200).json({ token, username: user.username, name: user.name });
});
```

---

## üõ°Ô∏è Middleware de autenticaci√≥n

```js
const authenticateToken = (req, res, next) => {
  const token = req.headers['authorization'];
  if (!token) return res.status(401).json({ error: 'Token no proporcionado' });

  try {
    const decoded = jwt.verify(token, 'secreto');
    req.user = decoded;
    next();
  } catch {
    return res.status(401).json({ error: 'Token inv√°lido' });
  }
};
```

---

## üîê Ruta protegida

```js
app.get("/articles", authenticateToken, async (req, res) => {
  const sql = "SELECT * FROM article WHERE user_id = ?";
  const connection = await getConnection();
  const [articles] = await connection.query(sql, [req.user.id]);
  connection.end();

  res.json({ articles });
});
```

---

## üß≠ Flujo del cliente (front)

1. Usuario se registra o inicia sesi√≥n ‚Üí recibe token.
2. El token se guarda en localStorage.
3. Para rutas protegidas, el token se env√≠a en los headers:
   ```js
   fetch('/articles', {
     headers: {
       'authorization': token
     }
   });
   ```

---

## ‚úÖ Conclusi√≥n

- JWT permite manejar autenticaci√≥n sin sesiones ni cookies.
- Se debe proteger el token y configurar bien su expiraci√≥n.
- Usa siempre `bcrypt` para encriptar contrase√±as antes de almacenarlas.
